<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
        <form class="d-flex" id="searchForm">
          <input class="form-control me-2" type="search" placeholder="Enter a item- PIPE, TANK, WATER PUMP"
            aria-label="Search" id="searchInput" autocomplete="off" style="width: 600px; background-color: #f0f0f0;">
        </form>

        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item ">
            <a class="nav-link active" aria-current="page" href="addItem.html"
              style="background-color: yellowgreen; border-radius: 5px; padding: 0.5rem 1rem; margin-right: 10px; font-weight:400px;">Add
              Item</a>
          </li>

          <li class="nav-item ">
            <a class="nav-link active" aria-current="page" href="Bill.html" target="_blank"
              style="background-color: rgb(233, 93, 71); border-radius: 5px; padding: 0.5rem 1rem; color: white; font-weight:500;">Bill
              Page</a>
          </li>
        </ul>

      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col" style="width: 300px;">Item Name</th>
          <th scope="col" style="width: 150px;">Purchase cost</th>
          <th scope="col" style="width: 100px;">Unit</th>
          <th scope="col" style="width: 200px;">Customer price</th>
          <th scope="col" style="width: 180px;">Supervisor price</th>
          <th scope="col" style="width: 100px;">Add To Bill</th>
          <th scope="col" style="width: 100px;">Actions</th> <!-- New column for actions -->
        </tr>
      </thead>
      <tbody id="searchResults">
        <!-- Results will be displayed here -->
      </tbody>
    </table>
  </div>
  <script>
    window.onload = function () {
      console.log(1);
      defaultPage();
    };
    // localStorage.clear();
    document.getElementById('searchInput').addEventListener('keyup', function () {
      var searchTerm = this.value;
      var temp = encodeURIComponent(searchTerm);
      if (temp.length == 0) {
        defaultPage();
        return;
      }
      fetch('http://localhost:8080/searchItems/' + temp)
        .then(response => response.json())
        .then(data => {
          var searchResults = document.getElementById('searchResults');
          searchResults.innerHTML = ''; // Clear previous search results

          data.forEach(item => {
            var row = document.createElement('tr');

            row.innerHTML = `
                    <td>${item.item_name}</td>
                    <td>${item.purchase}</td>
                    <td>${item.unit}</td>
                    <td style="background-color: yellow;"><strong style="color: black;">${item.customer}</td>
                    <td>${item.supervisor}</td>
                    <td>
                      <button class="btn btn-danger btn-sm edit-btn" data-flag="0" >BILL</button></td> 
                                   
                    <td>
                      <button class="btn btn-primary btn-sm edit-btn" data-flag="1">Edit</button>
                    </td>
                `;
            searchResults.appendChild(row);
          });
          var editButtons = document.querySelectorAll('.edit-btn');
          editButtons.forEach(button => {
            button.addEventListener('click', function () {
              var currentItem = data.find(item => {
                console.log('Item Name:', item.item_name);
                console.log('Parent node:', this.parentNode.parentNode.cells[0].textContent);
                return item.item_name === this.parentNode.parentNode.cells[0].textContent;
              });
              console.log(currentItem);
              var flag = parseInt(this.getAttribute('data-flag'));
              if (flag === 1) editItem(JSON.stringify(currentItem));
              else billItem(JSON.stringify(currentItem));
            });
          });
        })
        .catch(error => {
          console.error('Error:', error);
        });
    });


    // Function to redirect to editItem.html with item details
    function editItem(currentItem) {
      // Store the item object in localStorage
      item = JSON.parse(currentItem);
      localStorage.setItem('item_id', item.item_id);
      localStorage.setItem('item_name', item.item_name);
      localStorage.setItem('item_purchase', item.purchase);
      localStorage.setItem('item_cus', item.customer);
      localStorage.setItem('item_sup', item.supervisor);
      localStorage.setItem('item_unit', item.unit);

      // Redirect to the editItem.html page
      window.location.href = 'editItem.html';
    }

    function billItem(currentItem) {
      Item = JSON.parse(currentItem);
      // Step 1: Retrieve existing data from local storage
      var existingData = localStorage.getItem("objectsKey");
      // Step 2: Parse the retrieved data into an array, or initialize an empty array if no data exists
      var objects = existingData ? JSON.parse(existingData) : [];
      // Step 3: Add a new object to the array
      var temp = objects.find(obj => obj.item_id === Item.item_id);
      if (temp) {
        alert('Already added to Bill.');
        return;
      }
      var newObject = { item_id: Item.item_id, item_name: Item.item_name, price: Item.customer, unit: Item.unit, quantity: 1 };
      objects.push(newObject);

      // Step 4: Serialize the updated array back into a string
      var serializedObjects = JSON.stringify(objects);

      // Step 5: Store the updated string back into local storage under the same key
      localStorage.setItem("objectsKey", serializedObjects);
      alert('ADDED !!!');
    }

    function defaultPage() {

      fetch('http://localhost:8080/default')
        .then(response => response.json())
        .then(data => {
          var searchResults = document.getElementById('searchResults');
          searchResults.innerHTML = ''; // Clear previous search results

          data.forEach(item => {
            var row = document.createElement('tr');

            row.innerHTML = `
                    <td>${item.item_name}</td>
                    <td>${item.purchase}</td>
                    <td>${item.unit}</td>
                    <td style="background-color: yellow;"><strong style="color: black;">${item.customer}</td>
                    <td>${item.supervisor}</td>
                    <td>
                      <button class="btn btn-danger btn-sm edit-btn" data-flag="0" >BILL</button></td> 
                                   
                    <td>
                      <button class="btn btn-primary btn-sm edit-btn" data-flag="1">Edit</button>
                    </td>
                `;
            searchResults.appendChild(row);
          });
        });
    }
  </script>


</body>

</html>